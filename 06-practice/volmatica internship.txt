#conversation manager
conversation_history = []
max_mesg_memory = 10


def add_message(role: str, content: str):
    conversation_history.append({
        "role": role,
        "content": content
    })

    if len(conversation_history) > max_mesg_memory:
        conversation_history.pop(0)


def get_conversation_text():
    context = ""
    for msg in conversation_history:
        if msg["role"] == "user":
            context += f"User: {msg['content']}\n"
        else:
            context += f"Assistant: {msg['content']}\n"
    return context


def get_all_messages():
    return conversation_history


def clear_conversation():
    conversation_history.clear()




#gemini model
from google import genai
from google.genai import types
from dotenv import load_dotenv
import os

load_dotenv()

client = genai.Client(
    api_key=os.getenv("GEMINI_API_KEY")
)


def chatbot(context: str):
    response = client.models.generate_content(
    model="gemini-3-flash-preview",
    contents=context,
    config=types.GenerateContentConfig(
    system_instruction="You are helpful who memorize user context, it's previous response and generate summaries it he asks"
    )
)
    return response.text



#routers/chatbot.py
from fastapi import APIRouter
from services.conversation_manager import add_message, get_conversation_text

from services.gemini_model import chatbot

router = APIRouter()


@router.post("/")
def chat(prompt: str):

    add_message("user", prompt)

    context = get_conversation_text()

    response = chatbot(context)

    add_message("assistant", response)

    return {
        "reply": response
    }



#routers/chatmemory.py
from fastapi import APIRouter
from services.conversation_manager import get_all_messages

router = APIRouter()


@router.get("/messages")
def get_messages():
    return {
        "chats": get_all_messages()
    }



#routers/delete_memory.py
from fastapi import APIRouter
from services.conversation_manager import clear_conversation

router = APIRouter()

@router.delete("/delete-memory")
def delete_memory():
    return {
        "memory": clear_conversation()
    }



main.py
from fastapi import FastAPI
from services.gemini_model import chatbot
from routers import chatbot, chat_memory, delete_memory

app = FastAPI()


@app.get("/")
def server_status():
    return {
        "status": 200,
        "message": "Server is running"
    }


app.include_router(chatbot.router, prefix="/Chatbot", tags=['ChatBot'])
app.include_router(chat_memory.router, prefix="/chat-memory", tags= ['Chat Memory'])
app.include_router(delete_memory.router, prefix="/delete-memory", tags= ['Delete Memory'])




#########################################
from pydantic import BaseModel, EmailStr, AnyUrl, Field, field_validator
from typing import List, Dict , Optional, Annotated
class Ubl(BaseModel):
    name: str
    email: str
    bank: str

    @field_validator('email') #by default mode= 'after'
    @classmethod
    def check_user(cls, value):
        valid_email = ['ubl.com', 'ubl-isb.com']
        email = value.split('@')[-1]

        if email not in valid_email:
            raise ValueError("Not a UBL Member")
        return value

ubl_info = {"name": "moiz ali", "email": "moiz@ubl.com", "bank": "ubl"}

ubl1 = Ubl(**ubl_info)

def check_ubl_employee(ubl: Ubl):
    print(ubl.name)
    print(ubl.email)
    print(ubl.bank)

    print("UBL Member")

check_ubl_employee(ubl1)










